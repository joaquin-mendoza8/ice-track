{% extends 'base.html' %}
{% import 'components/macros.html' as macros %}

{% block title %}Trouble Tickets{% endblock %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tickets.css') }}" type="text/css">
{% endblock %}

{% block content %}

    <!-- include here for modal -->
    {% include 'tickets/modals/tickets_add_modal.html' %}
    {% include 'tickets/modals/tickets_update_modal.html' %}
    {% include 'tickets/modals/tickets_summary_modal.html' %}

    <!-- Main content container -->
    <div class="container-md">
        <!-- Offcanvas sidebar -->
        {% include 'components/navbar.html' %}

        <!-- Main content -->
        <main class="ms-sm-auto px-md-4 pt-md-3">


            <!-- Title and header btns -->
            {% set ticket_popover %}
                {{ macros.info_popover("Trouble Tickets", "View all trouble ticket information.") }}
            {% endset %}

            {% set header_btns %}
                <div class="btn-group">
                    <button 
                        type="button" 
                        class="btn btn-primary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#tickets-add-modal">
                        + New Ticket
                    </button>
                    <button 
                        type="button" 
                        class="btn btn-secondary" 
                        data-bs-toggle="modal" 
                        data-bs-target="#tickets-summary-modal">
                        <i class="bi bi-file-bar-graph"></i>&nbsp;&nbsp;
                        Summary
                    </button>
                </div>
            {% endset %}

            {{ macros.section_header("Trouble Tickets", extra_html=header_btns | safe, popover=ticket_popover | safe) }}

            <!-- Query Search Bar-->
            <div class="query-container mb-4">

                <!-- Query Search Form -->
                <form method="GET" action="{{ url_for('tickets.tickets_query_tickets') }}" class="row g-3 mt-4">

                    <div class="row mb-3">

                        <!-- Customer Name -->
                        <div class="col-md-3">
                            {{ macros.input_group_floating(
                                label='Customer Name',
                                id='customer-name',
                                name='customer-name',
                                tooltip='Enter the customer name to search for tickets.',
                                is_required=false,
                            ) }}
                        </div>
                
                        <!-- Type of Problem -->
                        <div class="col-md-3">

                            {{ macros.input_group_floating(
                                label='Type of Problem',
                                id='problem-type',
                                name='problem-type',
                                tooltip='Enter the type of problem to search for tickets.',
                                is_required=false,
                            ) }}

                        </div>
                
                        <!-- Problem Status -->
                        <div class="col-md-2">

                            {% set options = [('open', 'Open'), 
                                            ('in_progress', 'In Progress'), 
                                            ('resolved', 'Resolved')] %}

                            {{ macros.select_group_floating(
                                label='Problem Status',
                                id='problem-status',
                                name='problem-status',
                                options=options,
                                tooltip='Select the status of the problem to search for tickets.',
                                is_required=false,
                            ) }}

                        </div>

                    </div>

                    <div class="row mb-3">
                
                        <!-- Date Reported -->
                        <div class="col-md-4">

                            <div class="input-group">

                                {{ macros.input_group_floating(
                                    label='Date Reported (Start)',
                                    id='date-reported-start',
                                    name='date-reported-start',
                                    type='date',
                                    tooltip='Enter the start date the problem was reported.',
                                    is_required=false,
                                ) }}

                                {{ macros.input_group_floating(
                                    label='Date Reported (End)',
                                    id='date-reported-end',
                                    name='date-reported-end',
                                    type='date',
                                    tooltip='Enter the end date the problem was reported.',
                                    is_required=false,
                                ) }}

                            </div>

                        </div>

                        <!-- Date Resolved -->
                        <div class="col-md-4">

                            <div class="input-group">

                                {{ macros.input_group_floating(
                                    label='Date Resolved (Start)',
                                    id='date-resolved-start',
                                    name='date-resolved-start',
                                    type='date',
                                    tooltip='Enter the start date the problem was resolved.',
                                    is_required=false,
                                ) }}

                                {{ macros.input_group_floating(
                                    label='Date Resolved (End)',
                                    id='date-resolved-end',
                                    name='date-resolved-end',
                                    type='date',
                                    tooltip='Enter the end date the problem was resolved.',
                                    is_required=false,
                                ) }}
                            
                            </div>

                        </div>
                
                        <!-- Submit Button -->
                        <div class="col-md-2">
                            <button 
                                type="submit" 
                                class="btn btn-primary w-75 h-100">
                                <i class="bi bi-search"></i>&nbsp;&nbsp;Search
                            </button>
                        </div>

                    </div>
                </form>
            </div>
                
            <table class="table table-hover table-borderless">
                {% if tickets %}
                    <thead class="table-dark">
                        <tr>
                            {% for key in tickets[0].keys() %}
                                {% if key not in ['id'] %}
                                    <th scope="col">{{ key | attribute }}</th>
                                {% endif %}
                            {% endfor %}
                            {% if current_user.is_admin %}<th scope="col">Action</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                            <tr onclick="openModal({{ ticket }}, {{ ticket['id'] }})">
                                {% for key, value in ticket.items() %}
                                    {% if key not in ['id'] %}
                                        {% if key == 'source' %}
                                            <td>{{ value | title }}</td>
                                        {% elif 'date' in key %}
                                            <td>{{ value | date if value else '-' }}</td>
                                        {% elif key == 'problem_resolution' %}
                                            <td>{{ value.capitalize() if value else '-'}}</td>
                                        {% else %}
                                            <td>{{ value | capitalize }}</td>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                                <td>
                                    <!-- Only surface update ticket button if the current user is an admin -->
                                    {% if current_user.is_admin %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" 
                                        data-bs-target="#tickets-update-modal" ticket-id={{ticket['id']}}>
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                    {% else %}
                        No Outstanding Tickets.
                    {% endif %}
                </table>
            </div>
        </main>
    </div>
{% endblock %}

{% block scripts %}
    <script src="{{ url_for('static', filename='js/tickets.js') }}"></script>
{% endblock %}